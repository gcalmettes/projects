const html=document.querySelector("html"),body=document.querySelector("body"),grids=document.querySelectorAll(".grid-container"),gridItems=Array.from(grids).map(e=>Array.from(e.children)).reduce((e,t)=>[...e,...t.map(e=>initializeItem(e))],[]),transitionSettings={minHeight:500,speed:250};let currentPreview=null,scrollExtra=0,marginExpanded=10,windowSize={width:window.innerWidth,height:window.innerHeight};const isCloseTriggeringElement=e=>["item-close"].reduce((t,n)=>t|e.classList.contains(n),!1),isClassInElementTree=(e,t,n)=>!(n&&e.classList.contains(n))&&!!e.parentNode&&(!!e.classList.contains(t)||isClassInElementTree(e.parentNode,t,n));function initializeItem(e){return e.data=computeInitialItemData(e),e.addEventListener("click",function(e){let t=this,n=e.toElement||e.target,s=isClassInElementTree(n,"item-expander","grid-container");isCloseTriggeringElement(n)?hidePreview():currentPreview&&currentPreview.item===t&&!s?hidePreview():s?null:showPreview(t)}),e}function computeInitialItemData(e){regexURL=/\$[^$]*\$/g,regexMAP=/[^$|,]+/g;let t=e.getAttribute("data-urlMap").match(regexURL),n=t?t.map(e=>{let n=e.match(regexMAP),t=document.createElement("a");return t.setAttribute("class","urlMap"),t.setAttribute("target","_blank"),t.setAttribute("href",n[1]),t.innerText=decodeURIComponent(n[0]),t}):[];return{height:e.offsetHeight,offsetTop:e.offsetTop+e.offsetParent.offsetTop,imgLarge:e.getAttribute("data-largeSrc"),title:e.getAttribute("data-title"),description:e.getAttribute("data-description"),urls:n}}function updateItemData(e){e.data.offsetTop=e.offsetTop+e.offsetParent.offsetTop}const showPreview=e=>{currentPreview?currentPreview.item&&isOnSameRow(e,currentPreview.item)?currentPreview.update(e):(e.data.offsetTop>currentPreview.item.data.offsetTop&&(scrollExtra=currentPreview.item.data.offsetTop),currentPreview.close(),currentPreview=new Preview(e),currentPreview.open()):(currentPreview=new Preview(e),currentPreview.open())};function hidePreview(){currentPreview&&(currentPreview.close(),currentPreview=null)}function isOnSameRow(e,t){return!!t&&e.data.offsetTop==t.data.offsetTop}class ImagePreloader{constructor(e){this.imgUrl=e}preloadImage(){return new Promise((e)=>{const n=new Image;n.onload=e,n.onerror=e,n.src=this.imgUrl})}}class Preview{constructor(e){this.item=e,this.itemParent=e,this.expandedIdx=gridItems.findIndex(t=>t==e),this.create(),this.update()}create(){this.title=document.createElement("h3"),this.description=document.createElement("p"),this.details=document.createElement("div"),this.details.setAttribute("class","item-details"),this.details.append(this.title,this.description),this.loading=document.createElement("div"),this.loading.setAttribute("class","item-loading"),this.fullImage=document.createElement("div"),this.fullImage.setAttribute("class","item-fullImg"),this.fullImage.append(this.loading),this.closePreview=document.createElement("span"),this.closePreview.setAttribute("class","item-close"),this.previewInner=document.createElement("div"),this.previewInner.setAttribute("class","item-expander-inner"),this.previewInner.append(this.closePreview,this.fullImage,this.details),this.previewElement=document.createElement("div"),this.previewElement.setAttribute("class","item-expander"),this.previewElement.append(this.previewInner),this.item.appendChild(this.getElement())}getElement(){return this.previewElement}update(e){e&&(this.item.classList.remove("item-expanded"),this.item=e),this.item.classList.add("item-expanded"),this.title.innerText=this.item.data.title,this.description.innerText=this.item.data.description,document.querySelectorAll(".urlMap").forEach(e=>e.parentNode.removeChild(e)),this.details.append(...this.item.data.urls),this.imageElement&&this.fullImage.removeChild(this.imageElement);let t=new ImagePreloader(this.item.data.imgLarge);t.preloadImage().then(e=>{this.imageElement=document.createElement("img"),this.imageElement.setAttribute("src",this.item.data.imgLarge),this.fullImage.append(this.imageElement)})}open(){this.calculateAndSetHeight(),this.launchPreview()}close(){let t=this.itemParent.style.height.match(/[0-9]+/g)[0]-this.previewElement.parentNode.data.height,n=+this.previewElement.style.height.match(/[0-9]+/g)[0],e=this;new Promise((s)=>{animate({duration:transitionSettings.speed,timing:makeEaseOut(circ),draw:o=>{e.itemParent.style.height=`${e.previewElement.parentNode.data.height+(t-o*t)}px`,e.previewElement.style.height=`${n-o*n}px`,o==1&&s(!0)}})}).then(t=>{e.itemParent.removeChild(e.previewElement),e.item.classList.remove("item-expanded")})}calculateAndSetHeight(){let e=windowSize.height-this.item.data.height-marginExpanded,t=windowSize.height;e<transitionSettings.minHeight&&(e=transitionSettings.minHeight,t=transitionSettings.minHeight+this.item.data.height+marginExpanded),this.height=e,this.itemHeight=t}launchPreview(){let o=this.item.data.offsetTop,n=this.item.offsetParent.offsetTop+this.previewElement.offsetTop-scrollExtra,i=this.height+this.item.data.height+marginExpanded<=windowSize.height?o:this.height<windowSize.height?n-(windowSize.height-this.height):n;const t=Math.max(html.scrollTop,body.scrollTop),s=i-t,a=this.itemHeight-this.item.data.height;let e=this;animate({duration:transitionSettings.speed,timing:makeEaseOut(circ),draw:n=>{html.scrollTop=t+n*s,body.scrollTop=t+n*s,e.item.style.height=`${e.item.data.height+n*a}px`,e.previewElement.style.height=`${n*e.height}px`}})}transferOwnershipTo(){this.itemParent.style.height=`${this.itemParent.data.height}px`,this.itemParent.removeChild(this.previewElement),this.itemParent=this.item,this.item.style.height=`${this.itemHeight}px`,this.item.appendChild(this.previewElement)}}function animate({timing:e,draw:t,duration:n}){let s=performance.now();requestAnimationFrame(function o(i){let a=(i-s)/n;a>1&&(a=1);let r=e(a);t(r),a<1&&requestAnimationFrame(o)})}function circ(e){return e>1&&(e=1),1-Math.sin(Math.acos(e))}function makeEaseOut(e){return function(t){return 1-e(1-t)}}function updateItemsInfo(){gridItems.forEach(e=>updateItemData(e))}function updateParams(){windowSize={width:window.innerWidth,height:window.innerHeight},scrollExtra=0,updateItemsInfo()}const updateParamsSmartly=throttleAndDebounce(()=>{updateParams(),currentPreview&&currentPreview.item.data.offsetTop!=currentPreview.itemParent.data.offsetTop&&currentPreview.transferOwnershipTo(currentPreview.item)},200);window.addEventListener("resize",updateParamsSmartly);function throttleAndDebounce(e,t){let s=t,n=!1,o;return function(){let t=this,i=arguments;n||(e.apply(t,i),n=!0,setTimeout(()=>{n=!1},s));let a=function(){e.apply(t,i)};clearTimeout(o),o=setTimeout(a,s)}}